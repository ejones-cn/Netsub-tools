# 数字签名使用说明

本文档将指导您如何为IP子网分割工具添加数字签名，以减少360等安全软件的误报。

## 前提条件

在使用数字签名功能之前，您需要准备以下内容：

1. **代码签名证书**：您需要拥有有效的代码签名证书（.pfx格式）。如果没有，可以从以下机构购买：
   - DigiCert
   - GlobalSign
   - Sectigo
   - Comodo

2. **Windows SDK或Visual Studio**：确保您的系统已安装包含`SignTool`工具的Windows SDK或Visual Studio。
   - 如果未安装，可以从Microsoft官网下载Windows SDK：https://developer.microsoft.com/zh-cn/windows/downloads/windows-sdk/

3. **证书密码**：您需要知道代码签名证书的密码。

## 使用方法

### 1. 基本签名命令

使用以下命令生成带有数字签名的单文件版本：

```bash
python simple_pack.py --sign --cert-path=your_cert.pfx --password=your_password
```

请将以下参数替换为您自己的信息：
- `your_cert.pfx`：您的代码签名证书文件路径（相对或绝对路径均可）
- `your_password`：您的证书密码

### 2. 示例命令

假设您的证书文件位于D盘根目录，文件名为`my_cert.pfx`，密码为`MyPassword123`，则命令如下：

```bash
python simple_pack.py --sign --cert-path=D:\my_cert.pfx --password=MyPassword123
```

### 3. 查看帮助信息

如果需要查看完整的命令行选项，可以使用以下命令：

```bash
python simple_pack.py --help
```

## 执行流程

当您运行带有签名选项的命令后，脚本将执行以下操作：

1. 清理旧的打包文件（build和dist目录）
2. 生成单文件版本的EXE程序
3. 检查生成的EXE文件
4. 使用SignTool为EXE文件添加数字签名
5. 复制图标文件到输出目录
6. 显示打包和签名结果

## 签名成功的提示

如果签名成功，您将在命令输出中看到以下信息：

```
✅ 数字签名成功！
```

同时，在最终的提示信息中也会显示：

```
🔒 提示: 程序已进行数字签名，可降低360等安全软件的误报率
```

## 常见问题

### 1. SignTool未找到

**错误信息**：
```
❌ SignTool未找到，请确保已安装Windows SDK或Visual Studio
```

**解决方案**：
- 安装Windows SDK或Visual Studio
- 确保SignTool已添加到系统PATH环境变量中

### 2. 证书文件不存在

**错误信息**：
```
❌ 错误: 证书文件不存在: your_cert.pfx
```

**解决方案**：
- 检查证书文件路径是否正确
- 确保证书文件存在于指定位置

### 3. 证书密码错误

**错误信息**：
```
SignTool Error: The specified password is incorrect.
```

**解决方案**：
- 检查并输入正确的证书密码

### 4. 签名失败

**错误信息**：
```
❌ 数字签名失败: Command '['signtool', 'sign', ...]' returned non-zero exit status 1.
```

**解决方案**：
- 检查证书是否过期
- 确保证书支持代码签名
- 查看详细的错误信息以定位问题

## 注意事项

1. **证书成本**：代码签名证书通常需要购买，价格从几百到几千元不等，有效期一般为1-3年。

2. **签名效果**：数字签名可以显著降低360等安全软件的误报率，但不能保证100%避免误报。

3. **证书安全**：请妥善保管您的证书文件和密码，避免泄露。

4. **备份**：建议您备份代码签名证书，以防止证书丢失。

## 免费的数字签名解决方案

### 1. 自签名证书

您可以使用OpenSSL或Windows内置的证书管理器创建自签名证书。虽然自签名证书不会被默认信任，但可以用于测试或内部使用。

#### 使用OpenSSL创建自签名证书

1. 确保已安装OpenSSL（可以从https://slproweb.com/products/Win32OpenSSL.html下载）

2. 打开命令提示符，执行以下命令生成私钥：
```bash
openssl genrsa -out private.key 2048
```

3. 创建证书请求文件(CSR)：
```bash
openssl req -new -key private.key -out certificate.csr
```

4. 生成自签名证书：
```bash
openssl x509 -req -days 365 -in certificate.csr -signkey private.key -out certificate.crt
```

5. 将证书和私钥导出为PFX格式：
```bash
openssl pkcs12 -export -out my_signing_cert.pfx -inkey private.key -in certificate.crt
```

#### 使用Windows证书管理器创建自签名证书

1. 按Win+R键，输入`mmc`，打开Microsoft管理控制台
2. 点击"文件" -> "添加/删除管理单元"
3. 选择"证书"，点击"添加"
4. 选择"计算机账户"，点击"下一步"
5. 选择"本地计算机"，点击"完成"
6. 展开"证书(本地计算机)" -> "个人"
7. 右键点击"证书" -> "所有任务" -> "创建证书请求"
8. 按照向导创建证书请求，然后在"证书颁发机构"中使用"颁发证书"功能创建自签名证书
9. 右键点击创建的证书 -> "所有任务" -> "导出"
10. 选择PFX格式，包含私钥，设置密码并保存

### 2. 其他可能的免费选项

- **Sigstore**：一个开源项目，提供免费的代码签名和验证服务，但需要集成GitHub Actions等CI/CD工具
  - 官网：https://www.sigstore.dev/
  
- **Developer ID证书（macOS）**：苹果为macOS开发者提供的免费开发者证书，但仅适用于macOS平台
  
- **社区项目证书**：某些开源社区项目可能为贡献者提供免费的代码签名证书
  
- **教育机构证书**：如果您是学生或教育工作者，可以向学校申请免费的代码签名证书

### 3. 免费解决方案的限制

1. **信任问题**：自签名证书不会被Windows或第三方安全软件默认信任
2. **使用范围**：主要适用于测试、内部使用或个人项目
3. **安全软件误报**：免费证书可能无法有效减少360等安全软件的误报
4. **有效期短**：自签名证书通常有效期较短（如1年），需要定期更新
5. **平台限制**：某些免费证书可能仅适用于特定平台

### 4. 使用自签名证书的步骤

1. 创建自签名证书（如上述方法）
2. 将证书添加到Windows信任列表：
   - 双击PFX文件，按照向导导入证书
   - 选择"本地计算机" -> "将所有证书放入下列存储" -> "浏览" -> "受信任的根证书颁发机构"
   - 完成导入后，系统将信任此证书
3. 使用打包脚本签名程序：
   ```bash
   python simple_pack.py --sign --cert-path=my_signing_cert.pfx --password=your_password
   ```

## 获取付费代码签名证书

如果您需要在生产环境中使用或分发给最终用户，建议购买正式的代码签名证书：

1. **从证书颁发机构(CA)购买**：
   - DigiCert: https://www.digicert.com/
   - GlobalSign: https://www.globalsign.com/zh-cn/
   - Sectigo: https://www.sectigo.com/zh-cn/
   - Comodo: https://www.comodo.com/

2. **组织内部证书**：
   - 如果您在企业环境中工作，可以向IT部门申请内部代码签名证书

## 联系支持

如果您在使用数字签名功能时遇到问题，请检查以上常见问题或联系证书颁发机构获取支持。

---

**更新日期**：2024年
**版本**：1.0